{"version":3,"sources":["libs/brain.js"],"names":["DEBUG_SINGLE_LIMIT","DEBUG_SUM_LIMIT","Brain","id","options","processExited","debugLogQuotaUsed","ignoreAllEvents","maxTime","usedTime","process","spawnSandbox","bin","sandbox","affinity","maxMemory","stdout","setEncoding","on","handleProcessError","bind","handleProcessExit","stdin","allowStdout","handleStdoutLine","terminateProcess","err","emit","BrainError","message","exitCode","line","length","substr","indexOf","log","type","quotaUsed","action","data","totalElapsedMs","write","func","args","UserError","timeout","afterThis","p","resolve","reject","pause","beginTime","Date","now","once","endTime","resume","catch","TimeoutError"],"mappings":"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","file":"brain.js","sourcesContent":["import {EventEmitter2} from 'eventemitter2';\nimport byline from 'byline';\n\nimport errors from './errors';\nimport utils from './utils';\n\nconst DEBUG_SINGLE_LIMIT = 16 * 1024 + 10;\nconst DEBUG_SUM_LIMIT = 1 * 1024;\n\nexport default class Brain extends EventEmitter2 {\n  constructor(id, options) {\n    super();\n    this.id = id;\n    this.processExited = false;\n    this.debugLogQuotaUsed = 0;\n    this.ignoreAllEvents = false;\n\n    this.maxTime = options.maxTime;\n    this.usedTime = 0;\n\n    this.process = utils.spawnSandbox(options.bin, [], options.sandbox, {\n      affinity: options.affinity,\n      maxMemory: options.maxMemory,\n    });\n    this.process.stdout.setEncoding('utf8');\n    this.process.on('error', this.handleProcessError.bind(this));\n    this.process.on('exit', this.handleProcessExit.bind(this));\n    this.process.stdin.on('error', this.handleProcessError.bind(this));\n    this.process.stdout.on('error', this.handleProcessError.bind(this));\n\n    this.allowStdout = false;\n    this.stdout = byline(this.process.stdout);\n    this.stdout.on('data', this.handleStdoutLine.bind(this));\n  }\n\n  kill() {\n    if (this.processExited) {\n      return;\n    }\n    utils.terminateProcess(this.process);\n    this.processExited = true;\n  }\n\n  handleProcessError(err) {\n    if (this.processExited || this.ignoreAllEvents) {\n      return;\n    }\n    this.emit('error', new errors.BrainError(this.id, `Brain process error: ${err.message}`));\n  }\n\n  handleProcessExit(exitCode) {\n    if (this.processExited || this.ignoreAllEvents) {\n      return;\n    }\n    this.emit('exit', exitCode);\n  }\n\n  handleStdoutLine(line) {\n    if (this.processExited || this.ignoreAllEvents) {\n      return;\n    }\n    if (line.length > DEBUG_SINGLE_LIMIT) {\n      line = line.substr(0, DEBUG_SINGLE_LIMIT);\n    }\n    if (line.indexOf('DEBUG') === 0) {\n      if (this.debugLogQuotaUsed > DEBUG_SUM_LIMIT) {\n        return;\n      }\n      const message = line.substr(6);\n      this.debugLogQuotaUsed += message.length;\n      utils.log('debug', {type: 'brainDebug', id: this.id, message, quotaUsed: this.debugLogQuotaUsed});\n      return;\n    }\n    utils.log('debug', {action: 'receiveResponse', id: this.id, data: line, totalElapsedMs: this.usedTime});\n    if (!this.allowStdout) {\n      this.emit('error', new errors.BrainError(this.id, `Not allowed to respond, but received \"${line}\".`));\n      return;\n    }\n    this.emit('response', line);\n  }\n\n  writeInstruction(line) {\n    utils.log('debug', {action: 'sendRequest', id: this.id, data: line});\n    this.process.stdin.write(`${line}\\n`);\n  }\n\n  async emitErrorOnException(func, ...args) {\n    try {\n      await func(args);\n    } catch (e) {\n      if (!(e instanceof errors.UserError)) {\n        throw e;\n      }\n      let err = e;\n      if (e instanceof errors.UserError) {\n        if (!(e instanceof errors.BrainError)) {\n          err = new errors.BrainError(this.id, e.message);\n        }\n      }\n      this.emit('error', err);\n      throw err;\n    }\n  }\n\n  waitForOneResponse(timeout = 0, afterThis = function () {}) {\n    let p = new Promise((resolve, reject) => {\n      this.process.stdout.pause();\n      this.allowStdout = true;\n\n      afterThis();\n      const beginTime = Date.now();\n\n      this.once('response', data => {\n        const endTime = Date.now();\n        if (endTime - beginTime > 0) {\n          this.usedTime += (endTime - beginTime);\n        }\n        if (this.usedTime > this.maxTime) {\n          reject(new errors.BrainError(this.id, `Round timeout. Total elapsed time ${this.usedTime}ms exceeded the round time limit ${this.maxTime}ms.`));\n          return;\n        }\n        this.allowStdout = false;\n        resolve(data);\n      });\n      this.process.stdout.resume();\n    });\n    if (timeout > 0) {\n      p = p\n        .timeout(timeout)\n        .catch(Promise.TimeoutError, e => {\n          throw new errors.BrainError(this.id, `Response timeout. Expect a response within ${timeout}ms.`);\n        });\n    }\n    return p;\n  }\n\n}\n"]}