{"version":3,"sources":["judge.js"],"names":["config","JSON","readFile","toString","argvConfig","parse","log","message","shutdown","EXIT_ERROR","MSG_CAUSED_BY_SYS","BRAIN_IDS","id","brainsConfig","field","translateField","getOppositeField","forEach","bin","undefined","accessSync","constants","X_OK","err","core","parseInt","isNaN","moveTimeout","DEFAULT_MOVE_TIMEOUT","roundTimeout","DEFAULT_ROUND_TIMEOUT","memoryLimit","DEFAULT_MEMORY_LIMIT","roundConfig","size","DEFAULT_BOARD_SIZE","limit","DEFAULT_ROUND_LIMIT","action","board","brain","sandbox","affinity","maxMemory","maxTime","on","handleBrainError","handleBrainExit","code","brains","hasShutdown","all","map","emitErrorOnException","waitForOneResponse","DEFAULT_START_TIMEOUT","writeInstruction","resp","UserError","lastPlacement","ended","currentBrainId","getCurrentBrain","anotherBrain","m","match","placement","place","x","y","option","state","BOARD_STATE_DRAW","EXIT_DRAW","BOARD_STATE_WIN_BLACK","FIELD_BLACK","EXIT_B0_WIN","EXIT_B1_WIN","BOARD_STATE_WIN_WHITE","FIELD_WHITE","Error","ignoreAllEvents","main","nextField","exitCode","causedBy","kill","summary","summaryData","elapsedRoundTime","mapValues","exitCausedBy","currentBoard","getBoardMap","boardOrder","getOrderMap","data","writeFileSync","process","exit","type","error","getCodeForBrainLose","catch","e","stack"],"mappings":"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","file":"judge.js","sourcesContent":["import fs from 'fs';\nimport _ from 'lodash';\nimport fsp from 'fs-promise';\nimport {argv} from 'yargs';\n\nimport utils from './libs/utils';\nimport Brain from './libs/brain';\nimport Board from './libs/board';\nimport errors from './libs/errors';\nimport exitCode from './libs/exitCode';\n\nconst MSG_CAUSED_BY_SYS = 'Judge system internal error';\n\nconst DEFAULT_ROUND_LIMIT = 120;\nconst DEFAULT_BOARD_SIZE = 16;\nconst DEFAULT_START_TIMEOUT = 5000;\nconst DEFAULT_MOVE_TIMEOUT = 5000;\nconst DEFAULT_ROUND_TIMEOUT = 180000;\nconst DEFAULT_MEMORY_LIMIT = 350 * 1024 * 1024;\n\nconst BRAIN_IDS = ['0', '1'];\n\nconst roundConfig = {};\nconst brains = {};\nconst brainsConfig = {};\n\nlet board = null;\nlet argvConfig = {};\nlet hasShutdown = false;\n\nfunction getCurrentBrain() {\n  return brains[0].config.field === board.nextField ? 0 : 1;\n}\n\nfunction shutdown(exitCode, causedBy) {\n  utils.log('debug', {action: 'shutdown', exitCode, causedBy});\n  _.forEach(brains, brain => {\n    brain.ignoreAllEvents = true;\n    brain.kill();\n  });\n\n  if (argvConfig && argvConfig.summary) {\n    const summaryData = {\n      elapsedRoundTime: _.mapValues(brains, 'usedTime'),\n      exitCausedBy: causedBy,\n      currentBoard: board ? board.getBoardMap() : null,\n      boardOrder: board ? board.getOrderMap() : null,\n      roundConfig,\n    };\n    utils.log('info', {action: 'summary', data: summaryData});\n    fs.writeFileSync(argvConfig.summary, JSON.stringify(summaryData));\n  }\n\n  hasShutdown = true;\n  process.exit(exitCode);\n}\n\nfunction handleBrainError(id, err) {\n  utils.log('info', {type: 'brainError', error: err.message, id});\n  shutdown(exitCode.getCodeForBrainLose(id), `Brain ${id} error: ${err.message}`);\n}\n\nfunction handleBrainExit(id) {\n  utils.log('info', {type: 'brainProcessExit', id});\n  shutdown(exitCode.getCodeForBrainLose(id), `Brain ${id} process terminated`);\n}\n\nasync function main() {\n  // set argvConfig\n  if (argv.config) {\n    try {\n      argvConfig = JSON.parse((await fsp.readFile(argv.config)).toString());\n    } catch (err) {\n      utils.log('error', {message: `Failed to parse config from \"argv.config\": ${err.message}`});\n      shutdown(exitCode.EXIT_ERROR, MSG_CAUSED_BY_SYS);\n      return;\n    }\n  } else {\n    argvConfig = argv;\n  }\n\n  // set brainsConfig\n  for (const id of BRAIN_IDS) {\n    brainsConfig[id] = {};\n  }\n  brainsConfig[0].field = argvConfig['brain0.field'];\n  if (brainsConfig[0].field !== 'black' && brainsConfig[0].field !== 'white') {\n    utils.log('error', {message: `Invalid argument \"brain0.field\", expecting \"black\" or \"white\", but received ${brainsConfig[0].field}`});\n    shutdown(exitCode.EXIT_ERROR, MSG_CAUSED_BY_SYS);\n    return;\n  }\n  // Translate text to constant\n  brainsConfig[0].field = Board.translateField(brainsConfig[0].field);\n  brainsConfig[1].field = Board.getOppositeField(brainsConfig[0].field);\n\n  _.forEach(brainsConfig, (config, id) => {\n    config.bin = argvConfig[`brain${id}.bin`];\n    if (config.bin === undefined) {\n      utils.log('error', {message: `Missing argument \"brain${id}.bin\"`});\n      shutdown(exitCode.EXIT_ERROR, MSG_CAUSED_BY_SYS);\n      return;\n    }\n    try {\n      fsp.accessSync(config.bin, fsp.constants.X_OK);\n    } catch (err) {\n      utils.log('error', {message: `Unable to access \"${config.bin}\"`});\n      shutdown(exitCode.EXIT_ERROR, MSG_CAUSED_BY_SYS);\n      return;\n    }\n    config.core = parseInt(argvConfig[`brain${id}.core`], 10);\n    if (isNaN(config.core)) {\n      config.core = false;\n    }\n    config.moveTimeout = parseInt(argvConfig[`brain${id}.moveTimeout`], 10);\n    if (isNaN(config.moveTimeout)) {\n      config.moveTimeout = DEFAULT_MOVE_TIMEOUT;\n    }\n    config.roundTimeout = parseInt(argvConfig[`brain${id}.roundTimeout`], 10);\n    if (isNaN(config.roundTimeout)) {\n      config.roundTimeout = DEFAULT_ROUND_TIMEOUT;\n    }\n    config.memoryLimit = parseInt(argvConfig[`brain${id}.memoryLimit`], 10);\n    if (isNaN(config.memoryLimit)) {\n      config.memoryLimit = DEFAULT_MEMORY_LIMIT;\n    }\n  });\n\n  // set roundConfig\n  roundConfig.size = parseInt(argvConfig['round.size'], 10);\n  if (isNaN(roundConfig.size)) {\n    roundConfig.size = DEFAULT_BOARD_SIZE;\n  }\n  roundConfig.limit = parseInt(argvConfig['round.limit'], 10);\n  if (isNaN(roundConfig.limit)) {\n    roundConfig.limit = DEFAULT_ROUND_LIMIT;\n  }\n\n  utils.log('debug', {action: 'initialize', roundConfig, brainsConfig});\n\n  board = new Board(roundConfig.size, roundConfig.limit);\n\n  // Spawn brain processes\n  _.forEach(brainsConfig, (config, id) => {\n    const brain = new Brain(id, {\n      bin: config.bin,\n      sandbox: argvConfig.sandbox,\n      affinity: config.core,\n      maxMemory: config.memoryLimit,\n      maxTime: config.roundTimeout,\n    });\n    brain.on('error', err => handleBrainError(id, err));\n    brain.on('exit', code => handleBrainExit(id, code));\n    brain.config = config;\n    brains[id] = brain;\n  });\n\n  if (hasShutdown) {\n    return;\n  }\n\n  // Send START to both side\n  try {\n    await Promise.all(_.map(brains, brain => brain.emitErrorOnException(async () => {\n      const resp = await brain.waitForOneResponse(DEFAULT_START_TIMEOUT, () => {\n        brain.writeInstruction(`START ${brain.config.field}`);\n      });\n      if (resp !== 'OK') {\n        throw new errors.UserError(`Expect \"OK\", but received \"${resp}\"`);\n      }\n    })));\n  } catch (err) {\n    if (err instanceof errors.UserError) {\n      return;\n    }\n    throw err;\n  }\n\n  // Send BEGIN or TURN\n  let lastPlacement = null;\n  while (!hasShutdown && (lastPlacement === null || lastPlacement.ended === false)) {\n    try {\n      const currentBrainId = getCurrentBrain();\n      const brain = brains[currentBrainId];\n      const anotherBrain = brains[1 - currentBrainId];\n      await brain.emitErrorOnException(async () => {\n        const resp = await brain.waitForOneResponse(brain.config.moveTimeout, () => {\n          brain.writeInstruction('TURN');\n        });\n        const m = resp.match(/^(-?\\d+) (-?\\d+) (-?\\d+)$/);\n        if (!m) {\n          throw new errors.UserError(`Invalid response. Expect a placement format as \"[X] [Y] [Z]\".`);\n        }\n        const placement = board.place(parseInt(m[1], 10), parseInt(m[2], 10), parseInt(m[3], 10));\n        lastPlacement = placement;\n        anotherBrain.writeInstruction(`PLACE ${placement.x} ${placement.y} ${placement.option}`);\n      });\n    } catch (err) {\n      if (err instanceof errors.UserError) {\n        return;\n      }\n      throw err;\n    }\n  }\n\n  // Round ended\n  let code;\n  if (board.state === Board.BOARD_STATE_DRAW) {\n    code = exitCode.EXIT_DRAW;\n  } else if (board.state === Board.BOARD_STATE_WIN_BLACK) {\n    if (brains[0].config.field === Board.FIELD_BLACK) {\n      code = exitCode.EXIT_B0_WIN;\n    } else {\n      code = exitCode.EXIT_B1_WIN;\n    }\n  } else if (board.state === Board.BOARD_STATE_WIN_WHITE) {\n    if (brains[0].config.field === Board.FIELD_WHITE) {\n      code = exitCode.EXIT_B0_WIN;\n    } else {\n      code = exitCode.EXIT_B1_WIN;\n    }\n  } else {\n    throw new Error(`Invalid board state ${board.state}`);\n  }\n\n  _.forEach(brain => brain.ignoreAllEvents = true);\n  shutdown(code, '(normal round exit)');\n}\n\nmain()\n  .catch(e => {\n    utils.log('error', {message: `Uncaught system exception: ${e.stack}`});\n    shutdown(exitCode.EXIT_ERROR, MSG_CAUSED_BY_SYS);\n  });\n"]}